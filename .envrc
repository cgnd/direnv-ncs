# Copyright (c) 2025 Common Ground Electronics <https://cgnd.dev>
# SPDX-License-Identifier: Apache-2.0

# Place this .envrc in the root directory of your NCS workspace

# Detect OS
case "$(uname -s)" in
  Darwin)
    TOOLS_OS="darwin"
    # On macOS, detect *hardware* arch (Rosetta-safe)
    if sysctl -n hw.optional.arm64 2>/dev/null | grep -q '^1$'; then
      ARCH="aarch64"
    else
      ARCH="x86_64"
    fi
    ;;
  Linux)
    TOOLS_OS="linux"
    ARCH="$(uname -m)"
    # Only support x86_64 Linux
    if [ "$ARCH" != "x86_64" ]; then
      echo "This script only supports x86_64 Linux. Detected architecture: $ARCH"
      return 0
    fi
    ;;
  *)
    # Unsupported OS - exit early without doing anything
    echo "This script only supports Linux and macOS. Detected OS: $(uname -s)"
    return 0
    ;;
esac

BASEDIR="./nrf/scripts"
REQUIREMENTS=$BASEDIR/requirements-fixed.txt
TOOLS_VERSIONS=$BASEDIR/tools-versions-${TOOLS_OS}.yml
TOOLCHAIN_VERSION=$(cat ${REQUIREMENTS} ${TOOLS_VERSIONS} | tr -d '\r' | sha256sum | head -c 10)
eval "$(nrfutil sdk-manager toolchain env --as-script --toolchain-bundle-id ${TOOLCHAIN_VERSION})"
source ./zephyr/zephyr-env.sh
